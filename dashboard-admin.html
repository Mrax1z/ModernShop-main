<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Live Chat</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { background:#f4f6fb; }
    .admin-container { max-width:900px; margin:30px auto; padding:20px; }
    .admin-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .chat-panel { background:white; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.06); padding:16px; height:70vh; display:flex; flex-direction:column; }
    .messages { flex:1; overflow:auto; padding:8px; display:flex; flex-direction:column; gap:10px; }
    .message { max-width:80%; padding:10px 12px; border-radius:12px; font-size:14px; }
    .message.user { align-self:flex-end; background:linear-gradient(135deg,#667eea,#764ba2); color:white; }
    .message.bot { align-self:flex-start; background:#eef1f8; color:#222; }
    .controls { display:flex; gap:8px; margin-top:12px; }
    .controls input[type="text"] { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #e6e9ef; }
    .controls button { padding:10px 14px; border-radius:8px; border:none; background:linear-gradient(135deg,#667eea,#764ba2); color:white; cursor:pointer; }
    .meta { font-size:13px; color:#6b7280; }
    .small { font-size:12px; color:#94a3b8; }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <div>
        <h2>Panel Admin - Live Chat</h2>
        <div class="small">Balas pesan pengguna secara real-time</div>
      </div>
      <div>
        <a href="index.html">Kembali ke toko</a>
        <button id="logoutBtn" class="auth-btn" style="margin-left:12px">Logout</button>
      </div>
    </div>

    <div class="chat-panel">
      <div id="messages" class="messages" aria-live="polite"></div>

      <div class="controls">
        <input id="adminName" type="text" placeholder="Nama admin (default: Admin)" />
        <input id="replyInput" type="text" placeholder="Tulis balasan..." />
        <button id="sendReply">Kirim</button>
      </div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const replyInput = document.getElementById('replyInput');
    const sendReply = document.getElementById('sendReply');
    const adminNameEl = document.getElementById('adminName');
    const key = 'live_chat_history_v1';

    // BroadcastChannel
    let bc = null;
    try { bc = new BroadcastChannel('live-chat'); } catch (e) { bc = null; }

    // Fallback: listen to storage events when BroadcastChannel unavailable
    if (!bc) {
      window.addEventListener('storage', (ev) => {
        try {
          if (ev.key === key && ev.newValue) {
            const list = JSON.parse(ev.newValue);
            const last = list[list.length - 1];
            if (last) appendMessageToList(last.text, last.sender, last.time || new Date().toISOString());
          }
        } catch (e) {}
      });
    }

    function renderHistory() {
      messagesEl.innerHTML = '';
      try {
        const raw = localStorage.getItem(key);
        const list = raw ? JSON.parse(raw) : [];
        list.forEach(item => {
          appendMessageToList(item.text, item.sender, item.time);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } catch (e) {
        console.error('Gagal memuat history', e);
      }
    }

    function appendMessageToList(text, sender, time) {
      const div = document.createElement('div');
      // Map sender to display side: admin -> right (use 'user' class), others -> left ('bot')
      const displayClass = (sender === 'admin') ? 'user' : 'bot';
      div.className = 'message ' + displayClass;
      const timeLabel = new Date(time).toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });
      div.innerHTML = `<div>${escapeHtml(text)}</div><div class="small">${timeLabel}</div>`;
      messagesEl.appendChild(div);
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"'`]/g, (s) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[s]));
    }

    // Listen for new messages via BroadcastChannel
    if (bc) {
      bc.onmessage = (ev) => {
        const msg = ev.data;
        if (!msg || !msg.type) return;
        if (msg.type === 'message') {
          // append to local storage as well
          try {
            const raw = localStorage.getItem(key);
            const list = raw ? JSON.parse(raw) : [];
            list.push({ text: String(msg.text), sender: msg.sender, time: new Date().toISOString() });
            localStorage.setItem(key, JSON.stringify(list));
          } catch (e) {}
          appendMessageToList(msg.text, msg.sender, msg.time || new Date().toISOString());
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }
      };
    }

    // Poll storage on open to load existing messages
    renderHistory();

    sendReply.addEventListener('click', () => {
      const text = replyInput.value.trim();
      if (!text) return;
      const adminName = adminNameEl.value.trim() || 'Admin';
      const payload = { type: 'admin-reply', text: `[${adminName}] ${text}`, time: new Date().toISOString() };

      // Save to history as from admin
      try {
        const raw = localStorage.getItem(key);
        const list = raw ? JSON.parse(raw) : [];
        list.push({ text: payload.text, sender: 'admin', time: payload.time });
        localStorage.setItem(key, JSON.stringify(list));
      } catch (e) {}

      // Notify clients
      if (bc) {
        try { bc.postMessage(payload); } catch (e) {}
      }

      appendMessageToList(payload.text, 'admin', payload.time);
      replyInput.value = '';
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    // Also send on Enter
    replyInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendReply.click(); });

    // Logout button â€” clear shop_user and redirect to admin login
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        try { localStorage.removeItem('shop_user'); } catch (e) { /* ignore */ }
        alert('Anda telah logout.');
        window.location.href = 'admin-login.html';
      });
    }
  </script>
</body>
</html>